# **Task 1 :**

# a)

## **1. Download & Import Library .**

```{r}
library(dplyr)
library(readr)
library(ggplot2)
library(stringr)
library(scales)
```

## **2. Read & Clean dataset .**

```{r}
df <- read_csv("Data for CW-20250626/Data for CW/Web Analytic_Dataset.csv")
df <- df %>%
  mutate(
    `Source / Medium` = str_to_title(`Source / Medium`),
    Revenue = as.numeric(str_remove_all(Revenue, ",")),
    Year = as.integer(Year)
  ) %>%
  group_by(Year, `Source / Medium`) %>%
  summarise(Revenue = sum(Revenue, na.rm = TRUE), .groups = "drop")
```

## 3.Identify top 3 sources overall

```{r}
top_sources <- df %>%
  group_by(`Source / Medium`) %>%
  summarise(TotalRevenue = sum(Revenue, na.rm = TRUE)) %>%
  arrange(desc(TotalRevenue)) %>%
  slice_head(n = 3) %>%
  pull(`Source / Medium`)
```

## 4.Filter for top 3 and prepare for plotting

```{r}
top3_revenue <- df %>%
  filter(`Source / Medium` %in% top_sources) %>%
  group_by(Year, `Source / Medium`) %>%
  summarise(TotalRevenue = sum(Revenue), .groups = "drop")
```

## 5.Plot

```{r}
ggplot(top3_revenue, aes(x = factor(Year), y = TotalRevenue, fill = `Source / Medium`)) +
  geom_col(position = position_dodge(width = 0.9)) +
  geom_text(
    aes(label = comma(TotalRevenue)),
    position = position_dodge(width = 0.9),
    vjust = -0.25,
    size = 3.5
  ) +
  scale_fill_manual(values = c("#1f77b4", "#ff7f0e", "#2ca02c")) +
  labs(
    title = "Top 3 Traffic Sources by Revenue",
    x = "Year",
    y = "Revenue",
    fill = "Source / Medium"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.1)))
```

# B) (use Source/Medium)

## 1.Import libraries

```{r}
library(tidyverse)
library(scales)
library(dplyr)
library(tidyr)

```

## 2.Load dataset

```{r}
data_path <- "Data for CW-20250626/Data for CW/Web Analytic_Dataset.csv" 
data <- read_csv(data_path)

```

## 3.Clean numeric columns, drop NAs, and calculate ConversionRate

```{r}
data_clean <- raw %>%
  mutate(
    Sessions       = as.numeric(str_remove_all(Sessions, ",")),
    Transactions   = as.numeric(str_remove_all(Transactions, ",")),
    ConversionRate = Transactions / Sessions
  ) %>%
  filter(!is.na(Sessions), !is.na(Transactions))

```

## 4.Create summary_table: average Conversion Rate by month for each source/medium

```{r}
summary_table <- data_clean %>%
  group_by(
    Year,
    Month = `Month of the year`,
    Source_Medium = `Source / Medium`
  ) %>%
  summarise(
    Total_Sessions      = sum(Sessions, na.rm = TRUE),
    Avg_Conversion_Rate = round(mean(ConversionRate, na.rm = TRUE) * 100, 2),
    .groups = "drop"
  ) %>%
  mutate(
    Month      = sprintf("%02d", as.numeric(Month)),
    Year_Month = paste(Year, Month, sep = "-")
  )
```

## 5.Print the detailed summary table

```{r}
print(summary_table)
```

## 6.Plot detailed Conversion Rate over time by source/medium

```{r}
ggplot(summary_table, aes(x = Year_Month, y = Avg_Conversion_Rate, fill = Source_Medium)) +
  geom_col(position = "dodge") +
  coord_flip() +
  labs(
    title = "Average Conversion Rate by Source / Medium",
    x     = "Year-Month",
    y     = "Average Conversion Rate (%)",
    fill  = "Source / Medium"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 9),
    axis.title.y = element_text(margin = margin(r = 10))
  )


```

## 7.Prepare the Top-5 line chart data (Sep 2019 – Aug 2020) and print top 5 table .

```{r}
# Filter data for the desired period
period_summary <- summary_table %>%
  filter(Year_Month >= "2019-09", Year_Month <= "2020-08")

# Identify top 5 sources based on the average conversion rate over the whole period
top5_sources <- period_summary %>%
  group_by(Source_Medium) %>%
  summarise(
    Period_Avg_Conv = mean(Avg_Conversion_Rate, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(Period_Avg_Conv)) %>%
  slice_head(n = 5) %>%
  pull(Source_Medium)

# Filter and reshape data for the top 5 sources
top5_detail <- period_summary %>%
  filter(Source_Medium %in% top5_sources) %>%
  select(Year_Month, Source_Medium, Avg_Conversion_Rate) %>%
  pivot_wider(
    names_from = Source_Medium,
    values_from = Avg_Conversion_Rate
  ) %>%
  arrange(Year_Month)

# Calculate the average row
avg_row <- top5_detail %>%
  select(-Year_Month) %>%
  summarise(across(everything(), ~ round(mean(.x, na.rm = TRUE), 2))) %>%
  mutate(Year_Month = "Average") %>%
  select(Year_Month, everything())

# Combine monthly data with the average row
top5_detail_with_avg <- bind_rows(top5_detail, avg_row)

# Print detailed monthly table with average
print(top5_detail_with_avg, n = Inf)
```

## 8.Extract top 5 source names and ensure month factor ordering

```{r}
top5_sources <- top5_table$Source_Medium
line_data <- period_summary %>%
  filter(Source_Medium %in% top5_sources) %>%
  mutate(Year_Month = factor(Year_Month, levels = sort(unique(Year_Month))))
```

## 9.Line‐chart of Monthly Avg. Conversion Rate for Top 5 Sources

```{r}
ggplot(line_data, aes(x = Year_Month, y = Avg_Conversion_Rate,
                      color = Source_Medium, group = Source_Medium)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  labs(
    title    = "Monthly Conversion Rate for Top 5 Traffic Sources",
    subtitle = "Comparing average conversion trends (Sep 2019 – Aug 2020)",
    x        = "Month and Year",
    y        = "Average Conversion Rate (%)",
    color    = "Source / Medium"
  ) +
  theme_minimal() +
  theme(
    axis.text.x    = element_text(angle = 45, hjust = 1),
    plot.title     = element_text(face = "bold", size = 14),
    plot.subtitle  = element_text(size = 11, color = "gray40")
  )
```

# Task 2B : Analysis(devices) follows users/newusers

## 1.Load libraries 

```{r}
library(tidyverse)
library(readr)
library (scales)
```

## 2.Read the dataset and Clean,rename.

```{r}
df <- read_csv("Data for CW-20250626/Data for CW/Web Analytic_Dataset.csv")
df <- df %>%
  mutate(
    Users = as.numeric(str_replace_all(Users, ",", "")),
    New_Users = as.numeric(str_replace_all(`New Users`, ",", ""))
  ) %>%
  rename(Device = `Source / Medium`)
```

## 3.Summarize users by device and print summary table.

```{r}
user_summary <- df %>%
  group_by(Device) %>%
  summarise(
    Users = sum(Users, na.rm = TRUE),
    New_Users = sum(New_Users, na.rm = TRUE),
    .groups = "drop"
  )
print(user_summary)
```

## 4.Convert to long format for plotting

```{r}
user_long <- user_summary %>%
  pivot_longer(cols = c(Users, New_Users), names_to = "User_Type", values_to = "Count")
```

## 5.Plot 

```{r}
ggplot(user_long, aes(x = Device, y = Count, fill = User_Type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Users" = "cyan", "New_Users" = "pink")) +
  scale_y_continuous(labels = label_comma()) +  
  labs(
    title = "Users vs New Users by Device",
    x = "Device",
    y = "Number of Users",
    fill = "User Type"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1) 
  )
```

# C)

## 1.Import Library

```{r}
library(readr)
library(dplyr)
library(stringr)
library(janitor)
library(corrplot)
library(GGally)
library(tidyr)
library(ggplot2)
library(patchwork)   # for arranging our plots
```

## 2. Load & clean data

```{r}
df <- read_csv("E:/Coursework/Comp 1810/Data for CW-20250626/Data for CW/Web Analytic_Dataset.csv") %>%
  clean_names() %>%
  mutate(
    revenue         = as.numeric(str_remove_all(revenue, ",")),
    transactions    = as.numeric(str_remove_all(transactions, ",")),
    bounce_rate     = as.numeric(str_remove_all(bounce_rate, "%")),
    conversion_rate = if_else(conversion_rate_percent == "<0.01",
                              "0.01",
                              conversion_rate_percent),
    conversion_rate = as.numeric(str_remove_all(conversion_rate, "%"))
  ) %>%
  select(bounce_rate, conversion_rate, transactions, revenue) %>%
  drop_na()
```

## 3.Correlation matrix

```{r}
cor_matrix <- cor(df, use = "complete.obs")
```

## 4. Heatmap of correlations

```{r}
corrplot(
  cor_matrix,
  method      = "color",
  addCoef.col = "black",
  number.cex  = 0.8,
  tl.cex      = 0.8,
  title       = "Correlation Heatmap",
  mar         = c(0, 0, 2, 0)
)
```

## 5.Prepare relationship_df for the four custom scatter plots and four custom scatter plots

```{r}
relationship_df <- df %>%
  rename(
    Bounce_Rate     = bounce_rate,
    Conversion_Rate = conversion_rate,
    Transactions    = transactions,
    Revenue         = revenue
  )
# Bounce Rate vs Conversion Rate
ggplot(relationship_df, aes(x = Bounce_Rate, y = Conversion_Rate )) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "black", se = FALSE ) + 
  labs(
    title = "Relationship between Bounce Rate and Conversion Rate",
    x     = "Bounce_Rate",
    y     = "Conversion_Rate"
  ) +
  theme_minimal()

# Conversion Rate vs Transactions
ggplot(relationship_df, aes(x = Conversion_Rate, y = Transactions )) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "black", se = FALSE ) + 
  labs(
    title = "Relationship between Conversion Rate and Transaction",
    x     = "Conversion_Rate",
    y     = "Transactions"
  ) +
  theme_minimal()

# Transactions vs Revenue
ggplot(relationship_df, aes(x = Transactions, y = Revenue)) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "black", se = FALSE) + 
  labs(
    title = "Relationship between Transactions and Revenue",
    x     = "Transactions",
    y     = "Revenue"
  ) +
  theme_minimal()

# Bounce Rate vs Revenue
ggplot(relationship_df, aes(x = Bounce_Rate, y = Revenue )) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "black", se = FALSE ) + 
  labs(
    title = "Relationship between Bounce Rate and Revenue",
    x     = "Bounce_Rate",
    y     = "Revenue"
  ) +
  theme_minimal()


```

# Task 2:

# D)

## 0.Import Libraries .

```{r}
library(tidyverse)
```

## 1.Read the data.

```{r}
df2 <- read_csv("Data for CW-20250626/Data for CW/diabetes.csv")
```

## 2.Define a function to compute descriptive statistics

```{r}
desc_stats <- function(data_column) {
  if (is.numeric(data_column)) {
    mean_val   <- mean(data_column, na.rm = TRUE)
    median_val <- median(data_column, na.rm = TRUE)
    sd_val     <- sd(data_column, na.rm = TRUE)
    var_val    <- var(data_column, na.rm = TRUE)
    return(c(
      mean               = mean_val,
      median             = median_val,
      standard_deviation = sd_val,
      variance           = var_val
    ))
  } else {
    return(c(
      mean               = NA,
      median             = NA,
      standard_deviation = NA,
      variance           = NA
    ))
  }
}
```

## 3.Print descriptive statistics for each column in df2

```{r}
for (col_name in names(df2)) {
  cat(paste0("Statistics of ", col_name, "\n"))
  stats <- desc_stats(df2[[col_name]])
  for (stat_name in names(stats)) {
    cat(stat_name, ":", stats[[stat_name]], "\n")
  }
  cat("\n")
}
```

## 4.Plot histograms for each column

```{r}
for (col_name in names(df2)) {
  if (col_name == "Outcome") {
    p <- ggplot(df2, aes(x = factor(.data[[col_name]]))) +
      geom_bar(width = 0.3, fill = "pink", color = "black", alpha = 0.7) +
      labs(
        title = paste("Histogram of", col_name, "before cleaning"),
        x     = col_name,
        y     = "Frequency"
      ) +
      scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
      theme_light()
  } else {
    p <- ggplot(df2, aes_string(x = col_name)) +
      geom_histogram(bins = 30, fill = "pink", color = "black", alpha = 0.7) +
      labs(
        title = paste("Histogram of", col_name, "before cleaning"),
        x     = col_name,
        y     = "Frequency"
      ) +
      theme_light()
  }
  print(p)
}


```

## 5.Helper function to draw boxplots

```{r}
draw_boxplot <- function(column, title) {
  boxplot(column, main = title, horizontal = TRUE)
}
```

## 6.Draw boxplots for each numeric column

```{r}
draw_boxplot <- function(column, title) {
  boxplot(column, main = title, horizontal = TRUE)
}

for (col_name in names(df2)) {
  if (col_name == "Outcome") {
    # Pie chart for Outcome counts
    outcome_counts <- table(df2$Outcome)
    pie_labels <- paste0(names(outcome_counts), " (", as.vector(outcome_counts), ")")
    pie(
      outcome_counts,
      labels = pie_labels,
      main = "Pie Chart of Outcome before cleaning"
    )
    cat("\n")
  } else if (is.numeric(df2[[col_name]])) {
    title_text <- paste("Boxplot of", col_name, "before cleaning")
    draw_boxplot(df2[[col_name]], title = title_text)
    cat("\n")
  }
}
```

# Task E :

## 7.Create a cleaned version of df2:

```{r}
df2_clean <- df2 %>%
  mutate(
    Glucose       = na_if(Glucose, 0),
    BloodPressure = na_if(BloodPressure, 0),
    SkinThickness = na_if(SkinThickness, 0),
    Insulin       = na_if(Insulin, 0),
    BMI           = na_if(BMI, 0)
  ) %>%
  mutate(
    Glucose       = if_else(is.na(Glucose),       median(Glucose, na.rm = TRUE),       Glucose),
    BloodPressure = if_else(is.na(BloodPressure), median(BloodPressure, na.rm = TRUE), BloodPressure),
    SkinThickness = if_else(is.na(SkinThickness), median(SkinThickness, na.rm = TRUE), SkinThickness),
    Insulin       = if_else(is.na(Insulin),       median(Insulin, na.rm = TRUE),       Insulin),
    BMI           = if_else(is.na(BMI),           median(BMI, na.rm = TRUE),           BMI)
  )
print(df2_clean)
```

## 8.Recompute descriptive statistics on the cleaned data

```{r}
for (col_name in names(df2_clean)) {
  cat(paste0("Statistics of ", col_name, " after cleaning\n"))
  stats <- desc_stats(df2_clean[[col_name]])
  for (stat_name in names(stats)) {
    cat(stat_name, ":", stats[[stat_name]], "\n")
  }
  cat("\n")
}
```

## 9.Draw histograms titled “Histogram of … after cleaning”

```{r}
for (col_name in names(df2_clean)) {
  if (col_name == "Outcome") {
    p <- ggplot(df2_clean, aes(x = factor(.data[[col_name]]))) +
      geom_bar(width = 0.3, fill = "pink", color = "black", alpha = 0.7) +
      labs(
        title = paste("Histogram of", col_name, "after cleaning"),
        x     = col_name,
        y     = "Frequency"
      ) +
      scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
      theme_light()
    print(p)
  } else if (is.numeric(df2_clean[[col_name]])) {
    p <- ggplot(df2_clean, aes_string(x = col_name)) +
      geom_histogram(bins = 30, fill = "pink", color = "black", alpha = 0.7) +
      labs(
        title = paste("Histogram of", col_name, "after cleaning"),
        x     = col_name,
        y     = "Frequency"
      ) +
      theme_light()
    print(p)
  }
}

```

## 10.Boxplot after cleaning.

```{r}
for(col_name in names(df2_clean)) {
  if (col_name == "Outcome") {
    outcome_counts <- table(df2_clean$Outcome)
    pie_labels <- paste0(names(outcome_counts), " (", as.vector(outcome_counts), ")")
    pie(
      outcome_counts,
      labels = pie_labels,
      main = "Pie Chart of Outcome after cleaning"
    )
  } else if(is.numeric(df2_clean[[col_name]])) {
    p <- ggplot(df2_clean, aes_string(y = col_name)) +
      geom_boxplot(fill = "skyblue", outlier.color = "pink") +
      labs(
        title = paste("Boxplot of", col_name, "after cleaning"),
        x    = col_name
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank()
      )
    print(p)
  }
}

```
